<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DccHandler.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pircbotx</a> &gt; <a href="index.source.html" class="el_package">org.pircbotx.dcc</a> &gt; <span class="el_source">DccHandler.java</span></div><h1>DccHandler.java</h1><pre class="source lang-java linenums">// Generated by delombok at Mon Apr 13 22:36:03 CEST 2020
/**
 * Copyright (C) 2010-2014 Leon Blakey &lt;lord.quackstar at gmail.com&gt;
 *
 * This file is part of PircBotX.
 *
 * PircBotX is free software: you can redistribute it and/or modify it under the
 * terms of the GNU General Public License as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option) any later
 * version.
 *
 * PircBotX is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with
 * PircBotX. If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.pircbotx.dcc;

import java.io.Closeable;
import java.io.File;
import java.io.IOException;
import java.math.BigInteger;
import java.net.InetAddress;
import java.net.ServerSocket;
import java.net.Socket;
import java.net.UnknownHostException;
import java.security.SecureRandom;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Random;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.TimeUnit;
import org.pircbotx.Configuration;
import org.pircbotx.PircBotX;
import org.pircbotx.User;
import org.pircbotx.Utils;
import org.pircbotx.exception.DccException;
import org.pircbotx.hooks.events.IncomingChatRequestEvent;
import org.pircbotx.hooks.events.IncomingFileTransferEvent;
import static com.google.common.base.Preconditions.*;
import com.google.common.collect.ImmutableList;
import java.net.Inet6Address;
import lombok.NonNull;
import org.pircbotx.UserHostmask;

/**
 * Handler of all DCC requests
 * &lt;p&gt;
 * @author Leon Blakey
 */
public class DccHandler implements Closeable {
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@javax.annotation.Generated(&quot;lombok&quot;)
<span class="fc" id="L60">	private static final org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(DccHandler.class);</span>
<span class="fc" id="L61">	protected static final Random TOKEN_RANDOM = new SecureRandom();</span>
	protected static final int TOKEN_RANDOM_MAX = 20000;
	@NonNull
	protected final PircBotX bot;
<span class="fc" id="L65">	protected final Map&lt;PendingRecieveFileTransfer, CountDownLatch&gt; pendingReceiveTransfers = new HashMap&lt;PendingRecieveFileTransfer, CountDownLatch&gt;();</span>
<span class="fc" id="L66">	protected final List&lt;PendingSendFileTransfer&gt; pendingSendTransfers = new ArrayList&lt;PendingSendFileTransfer&gt;();</span>
<span class="fc" id="L67">	protected final Map&lt;PendingSendFileTransferPassive, CountDownLatch&gt; pendingSendPassiveTransfers = new HashMap&lt;PendingSendFileTransferPassive, CountDownLatch&gt;();</span>
<span class="fc" id="L68">	protected final Map&lt;PendingSendChatPassive, CountDownLatch&gt; pendingSendPassiveChat = new HashMap&lt;PendingSendChatPassive, CountDownLatch&gt;();</span>
<span class="fc" id="L69">	protected boolean shuttingDown = false;</span>
	
	public boolean processDcc(UserHostmask userHostmask, final User user, String request) throws IOException {
<span class="fc" id="L72">		List&lt;String&gt; requestParts = tokenizeDccRequest(request);</span>
<span class="fc" id="L73">		String type = requestParts.get(1);</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">		if (type.equals(&quot;SEND&quot;)) {</span>
			//Someone is trying to send a file to us
			//Example: DCC SEND &lt;filename&gt;  &lt;ip&gt; &lt;port&gt; &lt;file size&gt; &lt;transferToken&gt; (note File size is optional)
<span class="fc" id="L77">			String rawFilename = requestParts.get(2);</span>
<span class="pc bpc" id="L78" title="3 of 4 branches missed.">			final String safeFilename = (rawFilename.startsWith(&quot;\&quot;&quot;) &amp;&amp; rawFilename.endsWith(&quot;\&quot;&quot;)) ? rawFilename.substring(1, rawFilename.length() - 1) : rawFilename;</span>
<span class="fc" id="L79">			InetAddress address = parseRawAddress(requestParts.get(3));</span>
<span class="fc" id="L80">			int port = Integer.parseInt(requestParts.get(4));</span>
<span class="fc" id="L81">			long size = Long.parseLong(Utils.tryGetIndex(requestParts, 5, &quot;-1&quot;));</span>
<span class="fc" id="L82">			String transferToken = Utils.tryGetIndex(requestParts, 6, null);</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">			if (transferToken != null) </span>
			//Check if this is an acknowledgement of a passive dcc file request
<span class="fc" id="L85">			synchronized (pendingSendPassiveTransfers) {</span>
<span class="fc" id="L86">				Iterator&lt;Map.Entry&lt;PendingSendFileTransferPassive, CountDownLatch&gt;&gt; pendingItr = pendingSendPassiveTransfers.entrySet().iterator();</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">				while (pendingItr.hasNext()) {</span>
<span class="nc" id="L88">					Map.Entry&lt;PendingSendFileTransferPassive, CountDownLatch&gt; curEntry = pendingItr.next();</span>
<span class="nc" id="L89">					PendingSendFileTransferPassive transfer = curEntry.getKey();</span>
<span class="nc bnc" id="L90" title="All 6 branches missed.">					if (transfer.getUser() == user &amp;&amp; transfer.getFilename().equals(rawFilename) &amp;&amp; transfer.getTransferToken().equals(transferToken)) {</span>
<span class="nc" id="L91">						transfer.setReceiverAddress(address);</span>
<span class="nc" id="L92">						transfer.setReceiverPort(port);</span>
<span class="nc" id="L93">						log.debug(&quot;Passive send file transfer of file {} to user {} accepted at address {} and port {}&quot;, transfer.getFilename(), transfer.getUser().getNick(), address, port);</span>
<span class="nc" id="L94">						curEntry.getValue().countDown();</span>
<span class="nc" id="L95">						pendingItr.remove();</span>
<span class="nc" id="L96">						return true;</span>
					}
<span class="nc" id="L98">				}</span>
<span class="pc" id="L99">			}</span>
			//Nope, this is a new transfer
<span class="pc bpc" id="L101" title="1 of 4 branches missed.">			if (port == 0 || transferToken != null) </span>
			//User is trying to use reverse DCC
<span class="fc" id="L103">			bot.getConfiguration().getListenerManager().onEvent(new IncomingFileTransferEvent(bot, userHostmask, user, rawFilename, safeFilename, address, port, size, transferToken, true)); else bot.getConfiguration().getListenerManager().onEvent(new IncomingFileTransferEvent(bot, userHostmask, user, rawFilename, safeFilename, address, port, size, transferToken, false));</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">		} else if (type.equals(&quot;RESUME&quot;)) {</span>
			//Someone is trying to resume sending a file to us
			//Example: DCC RESUME &lt;filename&gt; 0 &lt;position&gt; &lt;token&gt;
			//Reply with: DCC ACCEPT &lt;filename&gt; 0 &lt;position&gt; &lt;token&gt;
<span class="nc" id="L108">			String filename = requestParts.get(2);</span>
<span class="nc" id="L109">			int port = Integer.parseInt(requestParts.get(3));</span>
<span class="nc" id="L110">			long position = Long.parseLong(requestParts.get(4));</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">			if (port == 0) {</span>
				//Passive transfer
<span class="nc" id="L113">				String transferToken = requestParts.get(5);</span>
<span class="nc" id="L114">				synchronized (pendingSendPassiveTransfers) {</span>
<span class="nc" id="L115">					Iterator&lt;Map.Entry&lt;PendingSendFileTransferPassive, CountDownLatch&gt;&gt; pendingItr = pendingSendPassiveTransfers.entrySet().iterator();</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">					while (pendingItr.hasNext()) {</span>
<span class="nc" id="L117">						Map.Entry&lt;PendingSendFileTransferPassive, CountDownLatch&gt; curEntry = pendingItr.next();</span>
<span class="nc" id="L118">						PendingSendFileTransferPassive transfer = curEntry.getKey();</span>
<span class="nc bnc" id="L119" title="All 6 branches missed.">						if (transfer.getUser() == user &amp;&amp; transfer.getFilename().equals(filename) &amp;&amp; transfer.getTransferToken().equals(transferToken)) {</span>
<span class="nc" id="L120">							transfer.setStartPosition(position);</span>
<span class="nc" id="L121">							log.debug(&quot;Passive send file transfer of file {} to user {} set to position {}&quot;, transfer.getFilename(), transfer.getUser().getNick(), position);</span>
<span class="nc" id="L122">							return true;</span>
						}
<span class="nc" id="L124">					}</span>
<span class="nc" id="L125">				}</span>
<span class="nc" id="L126">			} else synchronized (pendingSendTransfers) {</span>
<span class="nc" id="L127">				Iterator&lt;PendingSendFileTransfer&gt; pendingItr = pendingSendTransfers.iterator();</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">				while (pendingItr.hasNext()) {</span>
<span class="nc" id="L129">					PendingSendFileTransfer transfer = pendingItr.next();</span>
<span class="nc bnc" id="L130" title="All 6 branches missed.">					if (transfer.getUser() == user &amp;&amp; transfer.getFilename().equals(filename) &amp;&amp; transfer.getPort() == port) {</span>
<span class="nc" id="L131">						transfer.setPosition(position);</span>
<span class="nc" id="L132">						log.debug(&quot;Send file transfer of file {} to user {} set to position {}&quot;, transfer.getFilename(), transfer.getUser().getNick(), position);</span>
<span class="nc" id="L133">						return true;</span>
					}
<span class="nc" id="L135">				}</span>
<span class="nc" id="L136">			}</span>
			//Haven't returned yet, received an unknown transfer
<span class="nc" id="L138">			throw new DccException(DccException.Reason.UNKNOWN_FILE_TRANSFER_RESUME, user, &quot;Transfer line: &quot; + request);</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">		} else if (type.equals(&quot;ACCEPT&quot;)) {</span>
			//Someone is acknowledging a transfer resume
			//Example (normal):  DCC ACCEPT &lt;filename&gt; &lt;port&gt; &lt;position&gt;
			//Example (passive): DCC ACCEPT &lt;filename&gt; 0 &lt;position&gt; &lt;token&gt;
			//TODO how well does this handle non passive?
<span class="nc" id="L144">			String filename = requestParts.get(2);</span>
			int port;
<span class="nc" id="L146">			long position = Long.parseLong(requestParts.get(4));</span>
			String transferToken;
<span class="nc bnc" id="L148" title="All 2 branches missed.">			if (requestParts.size() == 5) {</span>
				//Standard request
<span class="nc" id="L150">				port = Integer.parseInt(requestParts.get(3));</span>
<span class="nc" id="L151">				transferToken = null;</span>
			} else {
				//Passive request
<span class="nc" id="L154">				port = 0;</span>
<span class="nc" id="L155">				transferToken = requestParts.get(5);</span>
			}
<span class="nc" id="L157">			synchronized (pendingReceiveTransfers) {</span>
<span class="nc" id="L158">				Iterator&lt;Map.Entry&lt;PendingRecieveFileTransfer, CountDownLatch&gt;&gt; pendingItr = pendingReceiveTransfers.entrySet().iterator();</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">				while (pendingItr.hasNext()) {</span>
<span class="nc" id="L160">					Map.Entry&lt;PendingRecieveFileTransfer, CountDownLatch&gt; curEntry = pendingItr.next();</span>
<span class="nc" id="L161">					IncomingFileTransferEvent transferEvent = curEntry.getKey().getEvent();</span>
<span class="nc bnc" id="L162" title="All 8 branches missed.">					if (transferEvent.getUser() == user &amp;&amp; transferEvent.getRawFilename().equals(filename) &amp;&amp; transferEvent.getPort() == port &amp;&amp; transferEvent.getToken().equals(transferToken)) {</span>
<span class="nc" id="L163">						curEntry.getKey().setPosition(position);</span>
<span class="nc" id="L164">						log.debug(&quot;Receive file transfer of file {} to user {} set to position {}&quot;, transferEvent.getRawFilename(), transferEvent.getUser().getNick(), position);</span>
<span class="nc" id="L165">						curEntry.getValue().countDown();</span>
<span class="nc" id="L166">						pendingItr.remove();</span>
<span class="nc" id="L167">						return true;</span>
					}
<span class="nc" id="L169">				}</span>
<span class="nc" id="L170">			}</span>
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">		} else if (type.equals(&quot;CHAT&quot;)) {</span>
			//Someone is trying to chat with us
			//Example: DCC CHAT &lt;protocol&gt; &lt;ip&gt; &lt;port&gt; (protocol should be chat)
<span class="fc" id="L174">			InetAddress address = parseRawAddress(requestParts.get(3));</span>
<span class="fc" id="L175">			int port = Integer.parseInt(requestParts.get(4));</span>
<span class="fc" id="L176">			String chatToken = Utils.tryGetIndex(requestParts, 5, null);</span>
			//Check if this is an acknowledgement of a passive chat request
<span class="fc bfc" id="L178" title="All 2 branches covered.">			if (chatToken != null) synchronized (pendingSendPassiveChat) {</span>
<span class="fc" id="L179">				Iterator&lt;Map.Entry&lt;PendingSendChatPassive, CountDownLatch&gt;&gt; pendingItr = pendingSendPassiveChat.entrySet().iterator();</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">				while (pendingItr.hasNext()) {</span>
<span class="nc" id="L181">					Map.Entry&lt;PendingSendChatPassive, CountDownLatch&gt; curEntry = pendingItr.next();</span>
<span class="nc" id="L182">					PendingSendChatPassive pendingChat = curEntry.getKey();</span>
<span class="nc" id="L183">					log.trace(&quot;Current pending chat: {}&quot;, pendingChat);</span>
<span class="nc bnc" id="L184" title="All 4 branches missed.">					if (pendingChat.getUser() == user &amp;&amp; pendingChat.getChatToken().equals(chatToken)) {</span>
<span class="nc" id="L185">						log.debug(&quot;Passive chat request to user {} accepted&quot;, user);</span>
<span class="nc" id="L186">						pendingChat.setReceiverAddress(address);</span>
<span class="nc" id="L187">						pendingChat.setReceiverPort(port);</span>
<span class="nc" id="L188">						curEntry.getValue().countDown();</span>
<span class="nc" id="L189">						pendingItr.remove();</span>
<span class="nc" id="L190">						return true;</span>
					}
<span class="nc" id="L192">				}</span>
<span class="pc" id="L193">			}</span>
			//Nope, this is a new chat
<span class="pc bpc" id="L195" title="3 of 4 branches missed.">			if (port == 0 &amp;&amp; chatToken != null) bot.getConfiguration().getListenerManager().onEvent(new IncomingChatRequestEvent(bot, userHostmask, user, address, port, chatToken, true)); else bot.getConfiguration().getListenerManager().onEvent(new IncomingChatRequestEvent(bot, userHostmask, user, address, port, chatToken, false));</span>
<span class="pc" id="L196">		} else return false;</span>
<span class="fc" id="L197">		return true;</span>
	}
	
	/**
	 * Accept chat request, blocking until the connection is active
	 * &lt;p&gt;
	 * @param event The chat request event
	 * @return An active {@link ReceiveChat}
	 * @throws IOException If an error occurred during connection
	 */
	public ReceiveChat acceptChatRequest(IncomingChatRequestEvent event) throws IOException {
<span class="nc" id="L208">		checkNotNull(event, &quot;Event cannot be null&quot;);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">		if (event.isPassive()) {</span>
<span class="nc" id="L210">			ServerSocket serverSocket = createServerSocket(event.getUser());</span>
<span class="nc" id="L211">			InetAddress publicAddress = getRealDccPublicAddress(serverSocket);</span>
<span class="nc" id="L212">			bot.sendDCC().chatPassiveAccept(event.getUser().getNick(), publicAddress, serverSocket.getLocalPort(), event.getToken());</span>
<span class="nc" id="L213">			log.debug(&quot;Sent DCC recieve chat accept to user {} ({}ms timeout) to passive connect on public address {}, local address {}&quot;, event.getUser().getNick(), bot.getConfiguration().getDccAcceptTimeout(), publicAddress, serverSocket.getLocalSocketAddress());</span>
<span class="nc" id="L214">			Socket userSocket = serverSocket.accept();</span>
			//User is connected, begin transfer
<span class="nc" id="L216">			serverSocket.close();</span>
<span class="nc" id="L217">			return bot.getConfiguration().getBotFactory().createReceiveChat(bot, event.getUser(), userSocket);</span>
		} else {
<span class="nc" id="L219">			InetAddress localAddress = getRealDccLocalAddress(event.getAddress());</span>
<span class="nc" id="L220">			log.debug(&quot;Accepting DCC recieve chat from user {} at address {} port {} from local address {}&quot;, event.getUser().getNick(), event.getAddress(), event.getPort(), localAddress);</span>
<span class="nc" id="L221">			return bot.getConfiguration().getBotFactory().createReceiveChat(bot, event.getUser(), new Socket(event.getAddress(), event.getPort(), localAddress, 0));</span>
		}
	}
	
	/**
	 * Accept file transfer at position 0, blocking until the connection is
	 * active
	 * &lt;p&gt;
	 * @param event The file request event
	 * @param destination The destination file
	 * @return An active {@link ReceiveFileTransfer}
	 * @throws IOException If an error occurred during connection
	 */
	public ReceiveFileTransfer acceptFileTransfer(IncomingFileTransferEvent event, File destination) throws IOException {
<span class="nc" id="L235">		checkNotNull(event, &quot;Event cannot be null&quot;);</span>
<span class="nc" id="L236">		checkNotNull(destination, &quot;Destination file cannot be null&quot;);</span>
<span class="nc" id="L237">		return acceptFileTransfer(event, destination, 0);</span>
	}
	
	/**
	 * Accept file transfer resuming at specified position, blocking until the
	 * connection is active
	 * &lt;p&gt;
	 * @param event The file request event
	 * @param destination The destination file
	 * @param startPosition The position to start the transfer at
	 * @return An active {@link ReceiveFileTransfer}
	 * @throws IOException If an error occurred during connection
	 * @throws InterruptedException If this is interrupted while waiting for a
	 * connection
	 * @throws DccException If a timeout is reached or the bot is shutting down
	 */
	public ReceiveFileTransfer acceptFileTransferResume(IncomingFileTransferEvent event, File destination, long startPosition) throws IOException, InterruptedException, DccException {
<span class="nc" id="L254">		checkNotNull(event, &quot;Event cannot be null&quot;);</span>
<span class="nc" id="L255">		checkNotNull(destination, &quot;Destination file cannot be null&quot;);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">		checkArgument(startPosition &gt;= 0, &quot;Start position %s must be positive&quot;, startPosition);</span>
		//Add to pending map so we can be notified when the user has accepted
<span class="nc" id="L258">		CountDownLatch countdown = new CountDownLatch(1);</span>
<span class="nc" id="L259">		PendingRecieveFileTransfer pendingTransfer = new PendingRecieveFileTransfer(event);</span>
<span class="nc" id="L260">		synchronized (pendingReceiveTransfers) {</span>
<span class="nc" id="L261">			pendingReceiveTransfers.put(pendingTransfer, countdown);</span>
<span class="nc" id="L262">		}</span>
		//Tell user were going to resume transfering
<span class="nc bnc" id="L264" title="All 2 branches missed.">		if (event.isPassive()) bot.sendDCC().filePassiveResumeRequest(event.getUser().getNick(), event.getRawFilename(), startPosition, event.getToken()); else bot.sendDCC().fileResumeRequest(event.getUser().getNick(), event.getRawFilename(), event.getPort(), startPosition);</span>
		//Wait for response
<span class="nc bnc" id="L266" title="All 2 branches missed.">		if (!countdown.await(bot.getConfiguration().getDccResumeAcceptTimeout(), TimeUnit.MILLISECONDS)) throw new DccException(DccException.Reason.FILE_TRANSFER_RESUME_TIMEOUT, event.getUser(), &quot;Event: &quot; + event);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">		if (shuttingDown) throw new DccException(DccException.Reason.FILE_TRANSFER_RESUME_CANCELLED, event.getUser(), &quot;Transfer &quot; + event + &quot; canceled due to bot shutting down&quot;);</span>
		//User has accepted resume, begin transfer
<span class="nc bnc" id="L269" title="All 2 branches missed.">		if (pendingTransfer.getPosition() != startPosition) log.warn(&quot;User is resuming transfer at position {} instead of requested position {} for transfer {}. Defaulting to users position&quot;, pendingTransfer.getPosition(), startPosition, event);</span>
<span class="nc" id="L270">		return acceptFileTransfer(event, destination, pendingTransfer.getPosition());</span>
	}
	
	protected ReceiveFileTransfer acceptFileTransfer(IncomingFileTransferEvent event, File destination, long startPosition) throws IOException {
<span class="nc" id="L274">		checkNotNull(event, &quot;Event cannot be null&quot;);</span>
<span class="nc" id="L275">		checkNotNull(destination, &quot;Destination file cannot be null&quot;);</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">		checkArgument(startPosition &gt;= 0, &quot;Start position %s must be positive&quot;, startPosition);</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">		if (event.isPassive()) {</span>
<span class="nc" id="L278">			ServerSocket serverSocket = createServerSocket(event.getUser());</span>
<span class="nc" id="L279">			bot.sendDCC().filePassiveAccept(event.getUser().getNick(), event.getRawFilename(), getRealDccPublicAddress(serverSocket), serverSocket.getLocalPort(), event.getFilesize(), event.getToken());</span>
<span class="nc" id="L280">			Socket userSocket = serverSocket.accept();</span>
			//User is connected, begin transfer
<span class="nc" id="L282">			serverSocket.close();</span>
<span class="nc" id="L283">			return bot.getConfiguration().getBotFactory().createReceiveFileTransfer(bot, userSocket, event.getUser(), destination, startPosition, event.getFilesize());</span>
		} else {
<span class="nc" id="L285">			Socket userSocket = new Socket(event.getAddress(), event.getPort(), getRealDccLocalAddress(event.getAddress()), 0);</span>
<span class="nc" id="L286">			return bot.getConfiguration().getBotFactory().createReceiveFileTransfer(bot, userSocket, event.getUser(), destination, startPosition, event.getFilesize());</span>
		}
	}
	
	/**
	 * Send a chat request using {@link Configuration#isDccPassiveRequest()}
	 * &lt;p&gt;
	 * @param receiver The user to chat with
	 * @return An active {@link SendChat}
	 * @throws IOException If an error occurred during connection
	 * @throws InterruptedException If passive connection was interrupted
	 * @throws DccException If a timeout is reached or the bot is shutting down
	 */
	public SendChat sendChat(User receiver) throws IOException, InterruptedException {
<span class="nc" id="L300">		return sendChat(receiver, bot.getConfiguration().isDccPassiveRequest());</span>
	}
	
	/**
	 * Send a chat request using passive parameter
	 * &lt;p&gt;
	 * @param receiver The user to chat with
	 * @param passive Whether to connect passively
	 * @return An active {@link SendChat}
	 * @throws IOException If an error occurred during connection
	 * @throws InterruptedException If passive connection was interrupted
	 * @throws DccException If a timeout is reached or the bot is shutting down
	 */
	public SendChat sendChat(User receiver, boolean passive) throws IOException, InterruptedException {
<span class="nc" id="L314">		checkNotNull(receiver, &quot;Receiver user cannot be null&quot;);</span>
<span class="nc" id="L315">		int dccAcceptTimeout = bot.getConfiguration().getDccAcceptTimeout();</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">		if (passive) {</span>
<span class="nc" id="L317">			String chatToken = Integer.toString(TOKEN_RANDOM.nextInt(TOKEN_RANDOM_MAX));</span>
<span class="nc" id="L318">			PendingSendChatPassive pendingChat = new PendingSendChatPassive(receiver, chatToken);</span>
<span class="nc" id="L319">			CountDownLatch countdown = new CountDownLatch(1);</span>
<span class="nc" id="L320">			synchronized (pendingSendPassiveChat) {</span>
<span class="nc" id="L321">				pendingSendPassiveChat.put(pendingChat, countdown);</span>
<span class="nc" id="L322">			}</span>
<span class="nc" id="L323">			InetAddress publicAddress = getRealDccPublicAddress();</span>
<span class="nc" id="L324">			bot.sendDCC().chatPassiveRequest(receiver.getNick(), publicAddress, chatToken);</span>
			//Wait for the user to acknowledge
<span class="nc" id="L326">			log.debug(&quot;Sent DCC send chat request to user {} ({}ms timeout) for passive connect info using public address {}&quot;, receiver.getNick(), bot.getConfiguration().getDccAcceptTimeout(), publicAddress);</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">			if (!countdown.await(dccAcceptTimeout, TimeUnit.MILLISECONDS)) throw new DccException(DccException.Reason.CHAT_TIMEOUT, receiver, &quot;&quot;);</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">			if (shuttingDown) throw new DccException(DccException.Reason.CHAT_CANCELLED, receiver, &quot;&quot;);</span>
<span class="nc" id="L329">			Socket chatSocket = new Socket(pendingChat.getReceiverAddress(), pendingChat.getReceiverPort());</span>
<span class="nc" id="L330">			return bot.getConfiguration().getBotFactory().createSendChat(bot, receiver, chatSocket);</span>
		} else {
			//Get the user to connect to us
<span class="nc" id="L333">			ServerSocket serverSocket = createServerSocket(receiver);</span>
<span class="nc" id="L334">			InetAddress publicAddress = getRealDccPublicAddress(serverSocket);</span>
<span class="nc" id="L335">			bot.sendDCC().chatRequest(receiver.getNick(), publicAddress, serverSocket.getLocalPort());</span>
			//Wait for user to connect
<span class="nc" id="L337">			log.debug(&quot;Sent DCC send chat request to user {} ({}ms timeout) to connect on public address {}:{}, local address {}&quot;, receiver.getNick(), bot.getConfiguration().getDccAcceptTimeout(), publicAddress, serverSocket.getLocalPort(), serverSocket.getLocalSocketAddress());</span>
<span class="nc" id="L338">			Socket userSocket = serverSocket.accept();</span>
<span class="nc" id="L339">			log.debug(&quot;Recieved connection&quot;);</span>
<span class="nc" id="L340">			serverSocket.close();</span>
<span class="nc" id="L341">			return bot.getConfiguration().getBotFactory().createSendChat(bot, receiver, userSocket);</span>
		}
	}
	
	/**
	 * Send file using {@link Configuration#isDccPassiveRequest() }
	 * &lt;p&gt;
	 * @param file The file to send
	 * @param receiver The user to send the file to
	 * @return An active {@link SendFileTransfer}
	 * @throws IOException If an error occurred during connecting
	 * @throws DccException If a timeout is reached or the bot is shutting down
	 * @throws InterruptedException If passive connection was interrupted
	 */
	public SendFileTransfer sendFile(File file, User receiver) throws IOException, DccException, InterruptedException {
<span class="nc" id="L356">		return sendFile(file, receiver, bot.getConfiguration().isDccPassiveRequest());</span>
	}
	
	/**
	 * Send file using {@link Configuration#isDccPassiveRequest() }
	 * &lt;p&gt;
	 * @param file The file to send
	 * @param receiver The user to send the file to
	 * @param passive Whether to connect passively
	 * @return An active {@link SendFileTransfer}
	 * @throws IOException If an error occurred during connecting
	 * @throws DccException If a timeout is reached or the bot is shutting down
	 * @throws InterruptedException If passive connection was interrupted
	 */
	public SendFileTransfer sendFile(File file, User receiver, boolean passive) throws IOException, DccException, InterruptedException {
<span class="nc" id="L371">		checkNotNull(file, &quot;Source file cannot be null&quot;);</span>
<span class="nc" id="L372">		checkNotNull(receiver, &quot;Receiver cannot be null&quot;);</span>
<span class="nc" id="L373">		checkArgument(file.exists(), &quot;File must exist&quot;);</span>
		//Make the filename safe to send
<span class="nc" id="L375">		String safeFilename = file.getName();</span>
<span class="nc bnc" id="L376" title="All 4 branches missed.">		if (safeFilename.contains(&quot; &quot;)) if (bot.getConfiguration().isDccFilenameQuotes()) safeFilename = &quot;\&quot;&quot; + safeFilename + &quot;\&quot;&quot;; else safeFilename = safeFilename.replace(&quot; &quot;, &quot;_&quot;);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">		if (passive) {</span>
<span class="nc" id="L378">			String transferToken = Integer.toString(TOKEN_RANDOM.nextInt(TOKEN_RANDOM_MAX));</span>
<span class="nc" id="L379">			CountDownLatch countdown = new CountDownLatch(1);</span>
<span class="nc" id="L380">			PendingSendFileTransferPassive pendingPassiveTransfer = new PendingSendFileTransferPassive(receiver, safeFilename, transferToken);</span>
<span class="nc" id="L381">			synchronized (pendingSendTransfers) {</span>
<span class="nc" id="L382">				pendingSendPassiveTransfers.put(pendingPassiveTransfer, countdown);</span>
<span class="nc" id="L383">			}</span>
<span class="nc" id="L384">			InetAddress publicAddress = getRealDccPublicAddress();</span>
<span class="nc" id="L385">			bot.sendDCC().filePassiveRequest(receiver.getNick(), safeFilename, publicAddress, file.length(), transferToken);</span>
			//Wait for user to acknowledge
<span class="nc" id="L387">			log.debug(&quot;Sent DCC send file request to user {} ({}ms timeout) for passive connect info using public address {} for file {}&quot;, receiver.getNick(), bot.getConfiguration().getDccAcceptTimeout(), publicAddress, file.getAbsolutePath());</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">			if (!countdown.await(bot.getConfiguration().getDccAcceptTimeout(), TimeUnit.MILLISECONDS)) throw new DccException(DccException.Reason.FILE_TRANSFER_TIMEOUT, receiver, &quot;File: &quot; + file.getAbsolutePath());</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">			if (shuttingDown) throw new DccException(DccException.Reason.FILE_TRANSFER_CANCELLED, receiver, &quot;Transfer of file &quot; + file.getAbsolutePath() + &quot; canceled due to bot shutdown&quot;);</span>
<span class="nc" id="L390">			Socket transferSocket = new Socket(pendingPassiveTransfer.getReceiverAddress(), pendingPassiveTransfer.getReceiverPort());</span>
<span class="nc" id="L391">			return bot.getConfiguration().getBotFactory().createSendFileTransfer(bot, transferSocket, receiver, file, pendingPassiveTransfer.getStartPosition());</span>
		} else {
			//Try to get the user to connect to us
<span class="nc" id="L394">			final ServerSocket serverSocket = createServerSocket(receiver);</span>
<span class="nc" id="L395">			PendingSendFileTransfer pendingSendFileTransfer = new PendingSendFileTransfer(receiver, safeFilename, serverSocket.getLocalPort());</span>
<span class="nc" id="L396">			synchronized (pendingSendTransfers) {</span>
<span class="nc" id="L397">				pendingSendTransfers.add(pendingSendFileTransfer);</span>
<span class="nc" id="L398">			}</span>
<span class="nc" id="L399">			InetAddress publicAddress = getRealDccPublicAddress(serverSocket);</span>
<span class="nc" id="L400">			bot.sendDCC().fileRequest(receiver.getNick(), safeFilename, publicAddress, serverSocket.getLocalPort(), file.length());</span>
			//Wait for the user to connect
<span class="nc" id="L402">			log.debug(&quot;Sent DCC send file request to user {} ({}ms timeout) to connect on public address {}, local address {}, port {} for file {}&quot;, receiver.getNick(), bot.getConfiguration().getDccAcceptTimeout(), publicAddress, serverSocket.getLocalSocketAddress(), serverSocket.getLocalPort(), file.getAbsolutePath());</span>
<span class="nc" id="L403">			Socket userSocket = serverSocket.accept();</span>
<span class="nc" id="L404">			serverSocket.close();</span>
<span class="nc" id="L405">			return bot.getConfiguration().getBotFactory().createSendFileTransfer(bot, userSocket, receiver, file, pendingSendFileTransfer.getPosition());</span>
		}
	}
	
	/**
	 * Try to get a real InetAddress in this order:
	 * &lt;ol&gt;
	 * &lt;li&gt;{@link Configuration#getDccLocalAddress()}&lt;/li&gt;
	 * &lt;li&gt;{@link Configuration#getLocalAddress()}&lt;/li&gt;
	 * &lt;li&gt;{@link PircBotX#getLocalAddress()}&lt;/li&gt;
	 * &lt;/ol&gt;
	 */
	public InetAddress getRealDccLocalAddress(InetAddress destAddress) {
		//Issue #268: Workaround to give IPv6 users an IPv6 address, or return null to let the OS figure it out
<span class="nc" id="L419">		InetAddress address = bot.getConfiguration().getDccLocalAddress();</span>
<span class="nc bnc" id="L420" title="All 4 branches missed.">		address = (address != null &amp;&amp; destAddress.getClass().equals(address.getClass())) ? address : bot.getConfiguration().getLocalAddress();</span>
<span class="nc bnc" id="L421" title="All 4 branches missed.">		address = (address != null &amp;&amp; destAddress.getClass().equals(address.getClass())) ? address : bot.getLocalAddress();</span>
<span class="nc bnc" id="L422" title="All 4 branches missed.">		address = (address != null &amp;&amp; destAddress.getClass().equals(address.getClass())) ? address : null;</span>
<span class="nc" id="L423">		return address;</span>
	}
	
	public InetAddress getRealDccLocalAddress() {
<span class="nc" id="L427">		InetAddress address = bot.getConfiguration().getDccLocalAddress();</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">		address = (address != null) ? address : bot.getConfiguration().getLocalAddress();</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">		address = (address != null) ? address : bot.getLocalAddress();</span>
<span class="nc" id="L430">		return address;</span>
	}
	
	/**
	 * Try to get a real InetAddress in this order:
	 * &lt;ol&gt;
	 * &lt;li&gt;{@link Configuration#getDccPublicAddress()}&lt;/li&gt;
	 * &lt;li&gt;{@link #getRealDccLocalAddress() }&lt;/li&gt;
	 * &lt;/ol&gt;
	 */
	public InetAddress getRealDccPublicAddress() {
<span class="nc" id="L441">		InetAddress address = bot.getConfiguration().getDccPublicAddress();</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">		return (address != null) ? address : getRealDccLocalAddress();</span>
	}
	
	/**
	 * Try to get a real InetAddress in this order:
	 * &lt;ol&gt;
	 * &lt;li&gt;{@link Configuration#getDccPublicAddress()}&lt;/li&gt;
	 * &lt;li&gt;The given ServerSocket's address&lt;/li&gt;
	 * &lt;/ol&gt;
	 */
	public InetAddress getRealDccPublicAddress(ServerSocket ss) {
<span class="nc" id="L453">		InetAddress address = bot.getConfiguration().getDccPublicAddress();</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">		return (address != null) ? address : ss.getInetAddress();</span>
	}
	
	protected ServerSocket createServerSocket(User user) throws IOException, DccException {
<span class="nc" id="L458">		InetAddress address = getRealDccLocalAddress();</span>
<span class="nc" id="L459">		ImmutableList&lt;Integer&gt; dccPorts = bot.getConfiguration().getDccPorts();</span>
<span class="nc" id="L460">		ServerSocket ss = null;</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">		if (dccPorts.isEmpty()) </span>
		// Use any free port.
<span class="nc" id="L463">		ss = new ServerSocket(0, 1, address); else {</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">			for (int currentPort : dccPorts) try {</span>
<span class="nc" id="L465">				ss = new ServerSocket(currentPort, 1, address);</span>
				// Found a port number we could use.
<span class="nc" id="L467">				break;</span>
<span class="nc" id="L468">			} catch (Exception e) {</span>
				// Do nothing; go round and try another port.
<span class="nc" id="L470">				log.debug(&quot;Failed to create server socket on port &quot; + currentPort + &quot;, trying next one&quot;, e);</span>
<span class="nc" id="L471">			}</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">			if (ss == null) </span>
			// No ports could be used.
<span class="nc" id="L474">			throw new DccException(DccException.Reason.DCC_PORTS_IN_USE, user, &quot;Ports &quot; + dccPorts + &quot; are in use.&quot;);</span>
		}
<span class="nc" id="L476">		ss.setSoTimeout(bot.getConfiguration().getDccAcceptTimeout());</span>
<span class="nc" id="L477">		return ss;</span>
	}
	
	protected static List&lt;String&gt; tokenizeDccRequest(String request) {
<span class="fc" id="L481">		int quotesIndexBegin = request.indexOf('\&quot;');</span>
<span class="pc bpc" id="L482" title="1 of 2 branches missed.">		if (quotesIndexBegin == -1) </span>
		//Just use tokenizeLine
<span class="fc" id="L484">		return Utils.tokenizeLine(request);</span>
		//This is a slightly modified version of Utils.tokenizeLine to parse
		//potential quotes in filenames
<span class="nc" id="L487">		int quotesIndexEnd = request.lastIndexOf('\&quot;');</span>
<span class="nc" id="L488">		List&lt;String&gt; stringParts = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L489">		int pos = 0;</span>
		int end;
<span class="nc bnc" id="L491" title="All 2 branches missed.">		while ((end = request.indexOf(' ', pos)) &gt;= 0) {</span>
<span class="nc bnc" id="L492" title="All 4 branches missed.">			if (pos &gt;= quotesIndexBegin &amp;&amp; end &lt; quotesIndexEnd) {</span>
				//We've entered the filename. Add and skip
<span class="nc" id="L494">				stringParts.add(request.substring(quotesIndexBegin, quotesIndexEnd + 1));</span>
<span class="nc" id="L495">				pos = quotesIndexEnd + 2;</span>
<span class="nc" id="L496">				continue;</span>
			}
<span class="nc" id="L498">			stringParts.add(request.substring(pos, end));</span>
<span class="nc" id="L499">			pos = end + 1;</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">			if (request.charAt(pos) == ':') {</span>
<span class="nc" id="L501">				stringParts.add(request.substring(pos + 1));</span>
<span class="nc" id="L502">				return stringParts;</span>
			}
		}
		//No more spaces, add last part of line
<span class="nc" id="L506">		stringParts.add(request.substring(pos));</span>
<span class="nc" id="L507">		return stringParts;</span>
	}
	
	/**
	 * Shutdown any pending dcc transfers
	 */
	public void close() {
		//Shutdown open reverse dcc servers
<span class="fc" id="L515">		shuttingDown = true;</span>
<span class="fc" id="L516">		int pendingCount = pendingReceiveTransfers.values().size() + pendingSendPassiveTransfers.values().size();</span>
<span class="pc bpc" id="L517" title="1 of 2 branches missed.">		if (pendingCount &gt; 0) {</span>
<span class="nc" id="L518">			log.info(&quot;Terminating {} DCC transfers waiting to be accepted&quot;, pendingCount);</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">			for (CountDownLatch curCountdown : pendingReceiveTransfers.values()) curCountdown.countDown();</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">			for (CountDownLatch curCountdown : pendingSendPassiveTransfers.values()) curCountdown.countDown();</span>
		}
<span class="fc" id="L522">	}</span>
	
	public static String addressToInteger(InetAddress address) {
<span class="fc bfc" id="L525" title="All 2 branches covered.">		if (address instanceof Inet6Address) return address.getHostAddress();</span>
<span class="fc" id="L526">		return new BigInteger(1, address.getAddress()).toString();</span>
	}
	
	public static InetAddress parseRawAddress(String rawAddress) throws UnknownHostException {
		//Some IPv6 clients are sending the full IPv6 address instead of a bigint
<span class="fc bfc" id="L531" title="All 2 branches covered.">		if (rawAddress.contains(&quot;:&quot;)) return Inet6Address.getByName(rawAddress);</span>
		//Convert the rawInteger into something usable
<span class="fc" id="L533">		BigInteger bigIp = new BigInteger(rawAddress);</span>
<span class="fc" id="L534">		byte[] addressBytes = bigIp.toByteArray();</span>
		//If there aren't enough bytes, pad with 0 byte
<span class="fc bfc" id="L536" title="All 2 branches covered.">		if (addressBytes.length == 5) </span>
		//Has signum, strip it
<span class="fc bfc" id="L538" title="All 2 branches covered.">		addressBytes = Arrays.copyOfRange(addressBytes, 1, 5); else if (addressBytes.length &lt; 4) {</span>
<span class="fc" id="L539">			byte[] newAddressBytes = new byte[4];</span>
<span class="fc" id="L540">			newAddressBytes[3] = addressBytes[0];</span>
<span class="pc bpc" id="L541" title="1 of 2 branches missed.">			newAddressBytes[2] = (addressBytes.length &gt; 1) ? addressBytes[1] : (byte)0;</span>
<span class="pc bpc" id="L542" title="1 of 2 branches missed.">			newAddressBytes[1] = (addressBytes.length &gt; 2) ? addressBytes[2] : (byte)0;</span>
<span class="pc bpc" id="L543" title="1 of 2 branches missed.">			newAddressBytes[0] = (addressBytes.length &gt; 3) ? addressBytes[3] : (byte)0;</span>
<span class="fc" id="L544">			addressBytes = newAddressBytes;</span>
<span class="pc bpc" id="L545" title="1 of 2 branches missed.">		} else if (addressBytes.length == 17) </span>
		//Has signum, strip it
<span class="nc" id="L547">		addressBytes = Arrays.copyOfRange(addressBytes, 1, 17);</span>
		try {
<span class="fc" id="L549">			return InetAddress.getByAddress(addressBytes);</span>
<span class="nc" id="L550">		} catch (UnknownHostException ex) {</span>
<span class="nc" id="L551">			throw new RuntimeException(&quot;Can\'t get InetAdrress version of int IP address &quot; + rawAddress + &quot; (bytes: &quot; + Arrays.toString(addressBytes) + &quot;)&quot;, ex);</span>
		}
	}
	
	protected static class PendingRecieveFileTransfer {
		protected final IncomingFileTransferEvent event;
		protected long position;
		
		@java.beans.ConstructorProperties({&quot;event&quot;})
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
<span class="nc" id="L562">		public PendingRecieveFileTransfer(final IncomingFileTransferEvent event) {</span>
<span class="nc" id="L563">			this.event = event;</span>
<span class="nc" id="L564">		}</span>
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public IncomingFileTransferEvent getEvent() {
<span class="nc" id="L569">			return this.event;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public long getPosition() {
<span class="nc" id="L575">			return this.position;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public void setPosition(final long position) {
<span class="nc" id="L581">			this.position = position;</span>
<span class="nc" id="L582">		}</span>
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public boolean equals(final java.lang.Object o) {
<span class="nc bnc" id="L588" title="All 2 branches missed.">			if (o == this) return true;</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">			if (!(o instanceof DccHandler.PendingRecieveFileTransfer)) return false;</span>
<span class="nc" id="L590">			final PendingRecieveFileTransfer other = (PendingRecieveFileTransfer)o;</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">			if (!other.canEqual((java.lang.Object)this)) return false;</span>
<span class="nc" id="L592">			final java.lang.Object this$event = this.getEvent();</span>
<span class="nc" id="L593">			final java.lang.Object other$event = other.getEvent();</span>
<span class="nc bnc" id="L594" title="All 6 branches missed.">			if (this$event == null ? other$event != null : !this$event.equals(other$event)) return false;</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">			if (this.getPosition() != other.getPosition()) return false;</span>
<span class="nc" id="L596">			return true;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		protected boolean canEqual(final java.lang.Object other) {
<span class="nc" id="L602">			return other instanceof DccHandler.PendingRecieveFileTransfer;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int hashCode() {
<span class="nc" id="L609">			final int PRIME = 59;</span>
<span class="nc" id="L610">			int result = 1;</span>
<span class="nc" id="L611">			final java.lang.Object $event = this.getEvent();</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">			result = result * PRIME + ($event == null ? 43 : $event.hashCode());</span>
<span class="nc" id="L613">			final long $position = this.getPosition();</span>
<span class="nc" id="L614">			result = result * PRIME + (int)($position &gt;&gt;&gt; 32 ^ $position);</span>
<span class="nc" id="L615">			return result;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public java.lang.String toString() {
<span class="nc" id="L622">			return &quot;DccHandler.PendingRecieveFileTransfer(event=&quot; + this.getEvent() + &quot;, position=&quot; + this.getPosition() + &quot;)&quot;;</span>
		}
	}
	
	protected static class PendingSendFileTransfer {
		protected final User user;
		protected final String filename;
		protected final int port;
<span class="nc" id="L630">		protected long position = 0;</span>
		
		@java.beans.ConstructorProperties({&quot;user&quot;, &quot;filename&quot;, &quot;port&quot;})
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
<span class="nc" id="L635">		public PendingSendFileTransfer(final User user, final String filename, final int port) {</span>
<span class="nc" id="L636">			this.user = user;</span>
<span class="nc" id="L637">			this.filename = filename;</span>
<span class="nc" id="L638">			this.port = port;</span>
<span class="nc" id="L639">		}</span>
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public User getUser() {
<span class="nc" id="L644">			return this.user;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public String getFilename() {
<span class="nc" id="L650">			return this.filename;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int getPort() {
<span class="nc" id="L656">			return this.port;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public long getPosition() {
<span class="nc" id="L662">			return this.position;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public void setPosition(final long position) {
<span class="nc" id="L668">			this.position = position;</span>
<span class="nc" id="L669">		}</span>
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public boolean equals(final java.lang.Object o) {
<span class="nc bnc" id="L675" title="All 2 branches missed.">			if (o == this) return true;</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">			if (!(o instanceof DccHandler.PendingSendFileTransfer)) return false;</span>
<span class="nc" id="L677">			final PendingSendFileTransfer other = (PendingSendFileTransfer)o;</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">			if (!other.canEqual((java.lang.Object)this)) return false;</span>
<span class="nc" id="L679">			final java.lang.Object this$user = this.getUser();</span>
<span class="nc" id="L680">			final java.lang.Object other$user = other.getUser();</span>
<span class="nc bnc" id="L681" title="All 6 branches missed.">			if (this$user == null ? other$user != null : !this$user.equals(other$user)) return false;</span>
<span class="nc" id="L682">			final java.lang.Object this$filename = this.getFilename();</span>
<span class="nc" id="L683">			final java.lang.Object other$filename = other.getFilename();</span>
<span class="nc bnc" id="L684" title="All 6 branches missed.">			if (this$filename == null ? other$filename != null : !this$filename.equals(other$filename)) return false;</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">			if (this.getPort() != other.getPort()) return false;</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">			if (this.getPosition() != other.getPosition()) return false;</span>
<span class="nc" id="L687">			return true;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		protected boolean canEqual(final java.lang.Object other) {
<span class="nc" id="L693">			return other instanceof DccHandler.PendingSendFileTransfer;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int hashCode() {
<span class="nc" id="L700">			final int PRIME = 59;</span>
<span class="nc" id="L701">			int result = 1;</span>
<span class="nc" id="L702">			final java.lang.Object $user = this.getUser();</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">			result = result * PRIME + ($user == null ? 43 : $user.hashCode());</span>
<span class="nc" id="L704">			final java.lang.Object $filename = this.getFilename();</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">			result = result * PRIME + ($filename == null ? 43 : $filename.hashCode());</span>
<span class="nc" id="L706">			result = result * PRIME + this.getPort();</span>
<span class="nc" id="L707">			final long $position = this.getPosition();</span>
<span class="nc" id="L708">			result = result * PRIME + (int)($position &gt;&gt;&gt; 32 ^ $position);</span>
<span class="nc" id="L709">			return result;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public java.lang.String toString() {
<span class="nc" id="L716">			return &quot;DccHandler.PendingSendFileTransfer(user=&quot; + this.getUser() + &quot;, filename=&quot; + this.getFilename() + &quot;, port=&quot; + this.getPort() + &quot;, position=&quot; + this.getPosition() + &quot;)&quot;;</span>
		}
	}
	
	protected static class PendingSendFileTransferPassive {
		protected final User user;
		protected final String filename;
		protected final String transferToken;
<span class="nc" id="L724">		protected long startPosition = 0;</span>
		protected InetAddress receiverAddress;
		protected int receiverPort;
		
		@java.beans.ConstructorProperties({&quot;user&quot;, &quot;filename&quot;, &quot;transferToken&quot;})
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
<span class="nc" id="L731">		public PendingSendFileTransferPassive(final User user, final String filename, final String transferToken) {</span>
<span class="nc" id="L732">			this.user = user;</span>
<span class="nc" id="L733">			this.filename = filename;</span>
<span class="nc" id="L734">			this.transferToken = transferToken;</span>
<span class="nc" id="L735">		}</span>
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public User getUser() {
<span class="nc" id="L740">			return this.user;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public String getFilename() {
<span class="nc" id="L746">			return this.filename;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public String getTransferToken() {
<span class="nc" id="L752">			return this.transferToken;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public long getStartPosition() {
<span class="nc" id="L758">			return this.startPosition;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public InetAddress getReceiverAddress() {
<span class="nc" id="L764">			return this.receiverAddress;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int getReceiverPort() {
<span class="nc" id="L770">			return this.receiverPort;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public void setStartPosition(final long startPosition) {
<span class="nc" id="L776">			this.startPosition = startPosition;</span>
<span class="nc" id="L777">		}</span>
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public void setReceiverAddress(final InetAddress receiverAddress) {
<span class="nc" id="L782">			this.receiverAddress = receiverAddress;</span>
<span class="nc" id="L783">		}</span>
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public void setReceiverPort(final int receiverPort) {
<span class="nc" id="L788">			this.receiverPort = receiverPort;</span>
<span class="nc" id="L789">		}</span>
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public boolean equals(final java.lang.Object o) {
<span class="nc bnc" id="L795" title="All 2 branches missed.">			if (o == this) return true;</span>
<span class="nc bnc" id="L796" title="All 2 branches missed.">			if (!(o instanceof DccHandler.PendingSendFileTransferPassive)) return false;</span>
<span class="nc" id="L797">			final PendingSendFileTransferPassive other = (PendingSendFileTransferPassive)o;</span>
<span class="nc bnc" id="L798" title="All 2 branches missed.">			if (!other.canEqual((java.lang.Object)this)) return false;</span>
<span class="nc" id="L799">			final java.lang.Object this$user = this.getUser();</span>
<span class="nc" id="L800">			final java.lang.Object other$user = other.getUser();</span>
<span class="nc bnc" id="L801" title="All 6 branches missed.">			if (this$user == null ? other$user != null : !this$user.equals(other$user)) return false;</span>
<span class="nc" id="L802">			final java.lang.Object this$filename = this.getFilename();</span>
<span class="nc" id="L803">			final java.lang.Object other$filename = other.getFilename();</span>
<span class="nc bnc" id="L804" title="All 6 branches missed.">			if (this$filename == null ? other$filename != null : !this$filename.equals(other$filename)) return false;</span>
<span class="nc" id="L805">			final java.lang.Object this$transferToken = this.getTransferToken();</span>
<span class="nc" id="L806">			final java.lang.Object other$transferToken = other.getTransferToken();</span>
<span class="nc bnc" id="L807" title="All 6 branches missed.">			if (this$transferToken == null ? other$transferToken != null : !this$transferToken.equals(other$transferToken)) return false;</span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">			if (this.getStartPosition() != other.getStartPosition()) return false;</span>
<span class="nc" id="L809">			final java.lang.Object this$receiverAddress = this.getReceiverAddress();</span>
<span class="nc" id="L810">			final java.lang.Object other$receiverAddress = other.getReceiverAddress();</span>
<span class="nc bnc" id="L811" title="All 6 branches missed.">			if (this$receiverAddress == null ? other$receiverAddress != null : !this$receiverAddress.equals(other$receiverAddress)) return false;</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">			if (this.getReceiverPort() != other.getReceiverPort()) return false;</span>
<span class="nc" id="L813">			return true;</span>
<span class="nc bnc" id="L814" title="All 50 branches missed.">		}</span>
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		protected boolean canEqual(final java.lang.Object other) {
<span class="nc" id="L819">			return other instanceof DccHandler.PendingSendFileTransferPassive;</span>
		}
		
<span class="nc" id="L822">		@java.lang.Override</span>
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int hashCode() {
<span class="nc" id="L826">			final int PRIME = 59;</span>
<span class="nc" id="L827">			int result = 1;</span>
<span class="nc" id="L828">			final java.lang.Object $user = this.getUser();</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">			result = result * PRIME + ($user == null ? 43 : $user.hashCode());</span>
<span class="nc" id="L830">			final java.lang.Object $filename = this.getFilename();</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">			result = result * PRIME + ($filename == null ? 43 : $filename.hashCode());</span>
<span class="nc" id="L832">			final java.lang.Object $transferToken = this.getTransferToken();</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">			result = result * PRIME + ($transferToken == null ? 43 : $transferToken.hashCode());</span>
<span class="nc" id="L834">			final long $startPosition = this.getStartPosition();</span>
<span class="nc" id="L835">			result = result * PRIME + (int)($startPosition &gt;&gt;&gt; 32 ^ $startPosition);</span>
<span class="nc" id="L836">			final java.lang.Object $receiverAddress = this.getReceiverAddress();</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">			result = result * PRIME + ($receiverAddress == null ? 43 : $receiverAddress.hashCode());</span>
<span class="nc" id="L838">			result = result * PRIME + this.getReceiverPort();</span>
<span class="nc" id="L839">			return result;</span>
		}
		
		@java.lang.Override
<span class="nc" id="L843">		@java.lang.SuppressWarnings(&quot;all&quot;)</span>
		@javax.annotation.Generated(&quot;lombok&quot;)
		public java.lang.String toString() {
<span class="nc" id="L846">			return &quot;DccHandler.PendingSendFileTransferPassive(user=&quot; + this.getUser() + &quot;, filename=&quot; + this.getFilename() + &quot;, transferToken=&quot; + this.getTransferToken() + &quot;, startPosition=&quot; + this.getStartPosition() + &quot;, receiverAddress=&quot; + this.getReceiverAddress() + &quot;, receiverPort=&quot; + this.getReceiverPort() + &quot;)&quot;;</span>
		}
	}
	
	protected static class PendingSendChatPassive {
		protected final User user;
		protected final String chatToken;
		protected InetAddress receiverAddress;
		protected int receiverPort;
		
		@java.beans.ConstructorProperties({&quot;user&quot;, &quot;chatToken&quot;})
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
<span class="nc" id="L859">		public PendingSendChatPassive(final User user, final String chatToken) {</span>
<span class="nc" id="L860">			this.user = user;</span>
<span class="nc" id="L861">			this.chatToken = chatToken;</span>
<span class="nc" id="L862">		}</span>
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public User getUser() {
<span class="nc" id="L867">			return this.user;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public String getChatToken() {
<span class="nc" id="L873">			return this.chatToken;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public InetAddress getReceiverAddress() {
<span class="nc" id="L879">			return this.receiverAddress;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int getReceiverPort() {
<span class="nc" id="L885">			return this.receiverPort;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public void setReceiverAddress(final InetAddress receiverAddress) {
<span class="nc" id="L891">			this.receiverAddress = receiverAddress;</span>
<span class="nc" id="L892">		}</span>
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public void setReceiverPort(final int receiverPort) {
<span class="nc" id="L897">			this.receiverPort = receiverPort;</span>
<span class="nc" id="L898">		}</span>
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public boolean equals(final java.lang.Object o) {
<span class="nc bnc" id="L904" title="All 2 branches missed.">			if (o == this) return true;</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">			if (!(o instanceof DccHandler.PendingSendChatPassive)) return false;</span>
<span class="nc" id="L906">			final PendingSendChatPassive other = (PendingSendChatPassive)o;</span>
<span class="nc bnc" id="L907" title="All 2 branches missed.">			if (!other.canEqual((java.lang.Object)this)) return false;</span>
<span class="nc" id="L908">			final java.lang.Object this$user = this.getUser();</span>
<span class="nc" id="L909">			final java.lang.Object other$user = other.getUser();</span>
<span class="nc bnc" id="L910" title="All 6 branches missed.">			if (this$user == null ? other$user != null : !this$user.equals(other$user)) return false;</span>
<span class="nc" id="L911">			final java.lang.Object this$chatToken = this.getChatToken();</span>
<span class="nc" id="L912">			final java.lang.Object other$chatToken = other.getChatToken();</span>
<span class="nc bnc" id="L913" title="All 6 branches missed.">			if (this$chatToken == null ? other$chatToken != null : !this$chatToken.equals(other$chatToken)) return false;</span>
<span class="nc" id="L914">			final java.lang.Object this$receiverAddress = this.getReceiverAddress();</span>
<span class="nc" id="L915">			final java.lang.Object other$receiverAddress = other.getReceiverAddress();</span>
<span class="nc bnc" id="L916" title="All 6 branches missed.">			if (this$receiverAddress == null ? other$receiverAddress != null : !this$receiverAddress.equals(other$receiverAddress)) return false;</span>
<span class="nc bnc" id="L917" title="All 2 branches missed.">			if (this.getReceiverPort() != other.getReceiverPort()) return false;</span>
<span class="nc" id="L918">			return true;</span>
		}
		
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		protected boolean canEqual(final java.lang.Object other) {
<span class="nc" id="L924">			return other instanceof DccHandler.PendingSendChatPassive;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public int hashCode() {
<span class="nc" id="L931">			final int PRIME = 59;</span>
<span class="nc" id="L932">			int result = 1;</span>
<span class="nc" id="L933">			final java.lang.Object $user = this.getUser();</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">			result = result * PRIME + ($user == null ? 43 : $user.hashCode());</span>
<span class="nc" id="L935">			final java.lang.Object $chatToken = this.getChatToken();</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">			result = result * PRIME + ($chatToken == null ? 43 : $chatToken.hashCode());</span>
<span class="nc" id="L937">			final java.lang.Object $receiverAddress = this.getReceiverAddress();</span>
<span class="nc bnc" id="L938" title="All 2 branches missed.">			result = result * PRIME + ($receiverAddress == null ? 43 : $receiverAddress.hashCode());</span>
<span class="nc" id="L939">			result = result * PRIME + this.getReceiverPort();</span>
<span class="nc" id="L940">			return result;</span>
		}
		
		@java.lang.Override
		@java.lang.SuppressWarnings(&quot;all&quot;)
		@javax.annotation.Generated(&quot;lombok&quot;)
		public java.lang.String toString() {
<span class="nc" id="L947">			return &quot;DccHandler.PendingSendChatPassive(user=&quot; + this.getUser() + &quot;, chatToken=&quot; + this.getChatToken() + &quot;, receiverAddress=&quot; + this.getReceiverAddress() + &quot;, receiverPort=&quot; + this.getReceiverPort() + &quot;)&quot;;</span>
		}
	}
	
	public static void main(String[] args) throws UnknownHostException {
<span class="nc" id="L952">		log.debug(&quot;IP: {}&quot;, parseRawAddress(&quot;134744072&quot;));</span>
<span class="nc" id="L953">	}</span>
	
	@java.beans.ConstructorProperties({&quot;bot&quot;})
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@javax.annotation.Generated(&quot;lombok&quot;)
<span class="fc" id="L958">	public DccHandler(@NonNull final PircBotX bot) {</span>
<span class="pc bpc" id="L959" title="1 of 2 branches missed.">		if (bot == null) {</span>
<span class="nc" id="L960">			throw new java.lang.NullPointerException(&quot;bot&quot;);</span>
		}
<span class="fc" id="L962">		this.bot = bot;</span>
<span class="fc" id="L963">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>