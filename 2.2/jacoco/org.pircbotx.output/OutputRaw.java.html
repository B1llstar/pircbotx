<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>OutputRaw.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pircbotx</a> &gt; <a href="index.source.html" class="el_package">org.pircbotx.output</a> &gt; <span class="el_source">OutputRaw.java</span></div><h1>OutputRaw.java</h1><pre class="source lang-java linenums">// Generated by delombok at Mon Apr 13 22:36:03 CEST 2020
/**
 * Copyright (C) 2010-2014 Leon Blakey &lt;lord.quackstar at gmail.com&gt;
 *
 * This file is part of PircBotX.
 *
 * PircBotX is free software: you can redistribute it and/or modify it under the
 * terms of the GNU General Public License as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option) any later
 * version.
 *
 * PircBotX is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with
 * PircBotX. If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.pircbotx.output;

import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.base.Preconditions.checkNotNull;
import java.io.IOException;
import java.util.List;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.ReentrantLock;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.text.WordUtils;
import org.pircbotx.PircBotX;
import org.pircbotx.Utils;
import org.slf4j.Marker;
import org.slf4j.MarkerFactory;
import com.google.common.base.Splitter;
import lombok.NonNull;

/**
 * Send raw lines to the server with locking and message delay support.
 * &lt;p&gt;
 * @author Leon Blakey
 */
public class OutputRaw {
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@javax.annotation.Generated(&quot;lombok&quot;)
<span class="fc" id="L45">	private static final org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(OutputRaw.class);</span>
<span class="fc" id="L46">	public static final Marker OUTPUT_MARKER = MarkerFactory.getMarker(&quot;pircbotx.output&quot;);</span>
	@NonNull
	protected final PircBotX bot;
<span class="fc" id="L49">	protected final ReentrantLock writeLock = new ReentrantLock(true);</span>
<span class="fc" id="L50">	protected final Condition writeNowCondition = writeLock.newCondition();</span>
<span class="fc" id="L51">	protected long lastSentLine = 0;</span>
	
	/**
	 * Sends a raw line through the outgoing message queue.
	 *
	 * @param line The raw line to send to the IRC server.
	 */
	public void rawLine(String line) {
<span class="fc" id="L59">		checkArgument(StringUtils.isNotBlank(line), &quot;Cannot send empty line to server: \'%s\'&quot;, line);</span>
<span class="fc" id="L60">		checkArgument(bot.isConnected(), &quot;Not connected to server&quot;);</span>
<span class="fc" id="L61">		long delayNanos = bot.getConfiguration().getMessageDelay().getDelay() * 1000000;</span>
<span class="fc" id="L62">		writeLock.lock();</span>
		try {
			//Block until we can send, taking into account a changing lastSentLine
<span class="fc" id="L65">			long curNanos = System.nanoTime();</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">			while (lastSentLine + delayNanos &gt; curNanos) {</span>
<span class="nc" id="L67">				writeNowCondition.await(lastSentLine + delayNanos - curNanos, TimeUnit.NANOSECONDS);</span>
<span class="nc" id="L68">				curNanos = System.nanoTime();</span>
			}
<span class="fc" id="L70">			log.info(OUTPUT_MARKER, line);</span>
<span class="fc" id="L71">			Utils.sendRawLineToServer(bot, line);</span>
<span class="fc" id="L72">			lastSentLine = System.nanoTime();</span>
<span class="nc" id="L73">		} catch (IOException e) {</span>
<span class="nc" id="L74">			throw new RuntimeException(&quot;IO exception when sending line to server, is the network still up? &quot; + exceptionDebug(), e);</span>
<span class="nc" id="L75">		} catch (InterruptedException e) {</span>
<span class="nc" id="L76">			throw new RuntimeException(&quot;Couldn\'t pause thread for message delay. &quot; + exceptionDebug(), e);</span>
<span class="nc" id="L77">		} catch (Exception e) {</span>
<span class="nc" id="L78">			throw new RuntimeException(&quot;Could not send line to server. &quot; + exceptionDebug(), e);</span>
		} finally {
<span class="pc" id="L80">			writeLock.unlock();</span>
<span class="pc" id="L81">		}</span>
<span class="fc" id="L82">	}</span>
	
	/**
	 * Sends a raw line to the IRC server as soon as possible without resetting
	 * the message delay for messages waiting to send
	 *
	 * @param line The raw line to send to the IRC server.
	 * @see #rawLineNow(java.lang.String, boolean)
	 */
	public void rawLineNow(String line) {
<span class="fc" id="L92">		rawLineNow(line, false);</span>
<span class="fc" id="L93">	}</span>
	
	/**
	 * Sends a raw line to the IRC server as soon as possible
	 * &lt;p&gt;
	 * @param line The raw line to send to the IRC server
	 * @param resetDelay If true, pending messages will reset their delay.
	 */
	public void rawLineNow(String line, boolean resetDelay) {
<span class="fc" id="L102">		checkNotNull(line, &quot;Line cannot be null&quot;);</span>
<span class="fc" id="L103">		checkArgument(bot.isConnected(), &quot;Not connected to server&quot;);</span>
<span class="fc" id="L104">		writeLock.lock();</span>
		try {
<span class="fc" id="L106">			log.info(OUTPUT_MARKER, line);</span>
<span class="fc" id="L107">			Utils.sendRawLineToServer(bot, line);</span>
<span class="fc" id="L108">			lastSentLine = System.nanoTime();</span>
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">			if (resetDelay) </span>
			//Reset the 
<span class="nc" id="L111">			writeNowCondition.signalAll();</span>
<span class="nc" id="L112">		} catch (IOException e) {</span>
<span class="nc" id="L113">			throw new RuntimeException(&quot;IO exception when sending line to server, is the network still up? &quot; + exceptionDebug(), e);</span>
<span class="nc" id="L114">		} catch (Exception e) {</span>
<span class="nc" id="L115">			throw new RuntimeException(&quot;Could not send line to server. &quot; + exceptionDebug(), e);</span>
		} finally {
<span class="pc" id="L117">			writeLock.unlock();</span>
<span class="pc" id="L118">		}</span>
<span class="fc" id="L119">	}</span>
	
	public void rawLineSplit(String prefix, String message) {
<span class="fc" id="L122">		rawLineSplit(prefix, message, &quot;&quot;);</span>
<span class="fc" id="L123">	}</span>
	
	public void rawLineSplit(String prefix, String message, String suffix) {
<span class="fc" id="L126">		checkNotNull(prefix, &quot;Prefix cannot be null&quot;);</span>
<span class="fc" id="L127">		checkNotNull(message, &quot;Message cannot be null&quot;);</span>
<span class="fc" id="L128">		checkNotNull(suffix, &quot;Suffix cannot be null&quot;);</span>
		//Find if final line is going to be shorter than the max line length
<span class="fc" id="L130">		String finalMessage = prefix + message + suffix;</span>
<span class="fc" id="L131">		int realMaxLineLength = bot.getConfiguration().getMaxLineLength() - 2;</span>
<span class="pc bpc" id="L132" title="1 of 6 branches missed.">		if (!bot.getConfiguration().isAutoSplitMessage() || (finalMessage.length() &lt; realMaxLineLength &amp;&amp; finalMessage.indexOf('\n') == -1)) {</span>
			//Length is good (or auto split message is false), just go ahead and send it
<span class="fc" id="L134">			rawLine(finalMessage);</span>
<span class="fc" id="L135">			return;</span>
		}
<span class="fc" id="L137">		int maxMessageLength = realMaxLineLength - (prefix + suffix).length();</span>
<span class="fc" id="L138">		List&lt;String&gt; lines = Splitter.on('\n').omitEmptyStrings().trimResults().splitToList(message);</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">		for (String line : lines) {</span>
<span class="fc" id="L140">			finalMessage = prefix + line + suffix;</span>
			//Too long, split it up
			//v3 word split, just use Apache commons lang
<span class="fc bfc" id="L143" title="All 2 branches covered.">			for (String curPart : StringUtils.split(WordUtils.wrap(line, maxMessageLength, &quot;\r\n&quot;, true), &quot;\r\n&quot;)) {</span>
<span class="fc" id="L144">				rawLine(prefix + curPart + suffix);</span>
			}
<span class="fc" id="L146">		}</span>
<span class="fc" id="L147">	}</span>
	
	/**
	 * Gets the number of lines currently waiting in the outgoing message Queue.
	 * If this returns 0, then the Queue is empty and any new message is likely
	 * to be sent to the IRC server immediately.
	 *
	 * @since PircBot 0.9.9
	 *
	 * @return The number of lines in the outgoing message Queue.
	 */
	public int getOutgoingQueueSize() {
<span class="nc" id="L159">		return writeLock.getHoldCount();</span>
	}
	
	protected String exceptionDebug() {
<span class="nc" id="L163">		return &quot;Connected: &quot; + bot.isConnected() + &quot; | Bot State: &quot; + bot.getState();</span>
	}
	
	@java.beans.ConstructorProperties({&quot;bot&quot;})
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@javax.annotation.Generated(&quot;lombok&quot;)
<span class="fc" id="L169">	public OutputRaw(@NonNull final PircBotX bot) {</span>
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">		if (bot == null) {</span>
<span class="nc" id="L171">			throw new java.lang.NullPointerException(&quot;bot&quot;);</span>
		}
<span class="fc" id="L173">		this.bot = bot;</span>
<span class="fc" id="L174">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>